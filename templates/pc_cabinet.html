<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    {% include 'pc_headers.html' %}
</head>
<body id="body">
<!-- Личный кабинет -->
<div class="catalog" style="background: #e9eaec">
    <div class="container">
        <div class="place_breadcoast">
            <a href="/">Главная</a> / <a href="/cabinet" class="active_page">Личный кабинет</a>
        </div>
        <h1 class="catalog_zag" style="text-align: center">Личный кабинет</h1>
        <div class="price_hover_price" style="text-align: center">
            Добрый день, <span id="name_user"></span>. В личном кабинете вы можете проверить
            ход выполнения ваших заказов, просмотреть
            или изменить личную информацию.
        </div>
    </div>
</div>


<div class="catalog" style="text-align: center">
    <div class="container">
        <div class="catalog_category " style="width: auto;">
            <div class="catalog_category_item _active" style="padding:0 15px;" id="personal_info_map">
                Личная информация
            </div>
        </div>
        <div class="catalog_category">
            <div class="catalog_category_item" id="personal_address_map">
                Адреса
            </div>
        </div>
        <div class="catalog_category">
            <div class="catalog_category_item" id="personal_history_map">
                История заказов
            </div>
        </div>
    </div>
</div>
<!-- Личная информация -->
<div class="catalog" style="padding-top:0;">
    <div class="container">
        <div class="catalog_flex createorder" style="padding:0;" id="personal_info">
            <!-- Личные данные -->
            <div class="requisites_place">
                <div class="name_buckets">
                    Личные данные
                </div>
                <input class="popup_input" placeholder="Ваше имя" id="your_name">
                <input class="popup_input" placeholder="Ваша фамилия" id="your_surname">
                <input class="popup_input" type="tel" placeholder="+7 (___) ___-__-__" id="your_mobile">
                <input class="popup_input" type="email" placeholder="Электронная почта" id="your_email_address">
                <div class="catalog_flex_catalog">
                    <div class="birthday_item">
                        <input class="popup_input" type="number" placeholder="День" id="birthday_day" maxlength="2">
                    </div>
                    <div class="birthday_item">
                        <input class="popup_input" type="number" placeholder="Месяц" id="birthday_month" maxlength="2">
                    </div>
                    <div class="birthday_item">
                        <input class="popup_input" type="number" placeholder="Год" id="birthday_year" maxlength="4">
                    </div>
                </div>
                <div class="all_catalog_href" style="float: none;width:100%;height:50px;" id="save_changes">
                    Сохранить изменения
                </div>
            </div>
            <!-- Пароль и ава -->
            <div class="your_order_place ">
                <div class="ava_place">
                    <div class="catalog_flex" style="justify-content: normal">
                        <img src="" class="avatar">

                        <input class="all_catalog_href" style="width: 100%" type="file"
                               id="avatar" placeholder="" value="">
                        <label for="avatar"></label>
                    </div>
                </div>

                <div class="name_buckets">
                    Пароль
                </div>
                <div id="place_for_old_pas">
                    <input class="popup_input" placeholder="Старый пароль" type="password" id="old_password">
                    <div class="all_catalog_href" style="float: none;width:100%;height:50px;" id="send_old_pas">
                        Проверить
                    </div>
                </div>
                <div id="enter_new_pas" style="display: none;">
                    <input class="popup_input" placeholder="Новый пароль" type="password" id="new_pass">
                    <input class="popup_input" placeholder="Повторите новый пароль" type="password"
                           id="new_pass_repeat">
                    <div class="all_catalog_href" style="float: none;width:100%;height:50px;" id="save_new_pas">
                        Сохранить изменения
                    </div>
                </div>
            </div>
        </div>

        <div class="catalog_flex createorder" style="padding:0;display: none" id="personal_address">
            <!-- Адреса -->
            <div class="address_place">
                <div class="address_item address_info">
                    <div class="catalog_flex">
                        <div class="address_info_zag">
                            Название:
                        </div>
                        <div class="address_info_zag" style="color:#FFFFFF">
                            Офис
                        </div>
                    </div>
                    <div class="catalog_flex">
                        <div class="address_info_zag">
                            Адрес:
                        </div>
                        <div class="address_info_zag" style="color:#FFFFFF">
                            Урывского, 2В
                        </div>
                    </div>

                    <div class="catalog_flex" style="border-bottom: 0;margin-top:10px;">
                        <div class="all_catalog_href"
                             style="background: #FFFFFF; color:#293048;height:70px;margin-right:10px;">
                            Изменить
                        </div>
                        <div class="all_catalog_href" style="height:70px;border: 4px solid #FFFFFF;">
                            Удалить
                        </div>
                    </div>
                </div>

                <div class="address_item add_adress">
                    <div class="catalog_flex">
                        <div class="right_nav_place">
                            <div class="right_nav_item">
                                <span class="fas fa-map-marker-alt"></span>
                            </div>
                        </div>
                        <div class="blog_item_text_read" style="margin-top: 15px;">
                            Добавить адреса
                        </div>
                    </div>
                </div>
                <div class="address_item add_adress">
                    <div class="catalog_flex">
                        <div class="right_nav_place">
                            <div class="right_nav_item">
                                <span class="fas fa-map-marker-alt"></span>
                            </div>
                        </div>
                        <div class="blog_item_text_read" style="margin-top: 15px;">
                            Добавить адреса
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="catalog_flex createorder" style="padding:0;display: none" id="personal_history">
            <!-- История заказов -->
            <div class="one_order_place">
                <div class="catalog_flex" style="justify-content: normal;margin-bottom:15px;">
                    <div style="width:48%;border-bottom: 2px solid #293048;margin-right:15px;">
                        <div class="catalog_flex">
                            <div class="address_info_zag">
                                Адрес:
                            </div>
                            <div class="address_info_zag" style="color:#293048">
                                УЛ. УРЫВСКОГО 2В
                            </div>
                        </div>
                    </div>
                    <div style="width:35%;border-bottom: 2px solid #293048;margin-right:15px;">
                        <div class="catalog_flex">
                            <div class="address_info_zag">
                                Стоимость заказа:
                            </div>
                            <div class="address_info_zag" style="color:#293048">
                                17 200 Р
                            </div>
                        </div>
                    </div>
                    <div style="width:25%;border-bottom: 2px solid #293048;">
                        <div class="catalog_flex">
                            <div class="address_info_zag">
                                Дата:
                            </div>
                            <div class="address_info_zag" style="color:#293048">
                                06.07.2021
                            </div>
                        </div>
                    </div>
                </div>


                <div class="catalog_flex" style="justify-content: normal;">
                    <div class="history_order_item">
                        <div class="catalog_flex" style="align-items: normal;justify-content: normal">
                            <div class="small_product_card" style="margin-right:15px;">
                                <div class="small_product_place">
                                    <img src="../static/img/slider_img.png" class="small_product_img">
                                </div>
                            </div>
                            <div>
                                <div class="bucket_na_zakaz">
                                    Букет индиго
                                </div>
                                <div class="price">
                                    5400 Р
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="history_order_item">
                        <div class="catalog_flex" style="align-items: normal;justify-content: normal">
                            <div class="small_product_card" style="margin-right:15px;">
                                <div class="small_product_place">
                                    <img src="../static/img/slider_img.png" class="small_product_img">
                                </div>
                            </div>
                            <div>
                                <div class="bucket_na_zakaz">
                                    Букет индиго
                                </div>
                                <div class="price">
                                    5400 Р
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="history_order_item">
                        <div class="catalog_flex" style="align-items: normal;justify-content: normal">
                            <div class="small_product_card" style="margin-right:15px;">
                                <div class="small_product_place">
                                    <img src="../static/img/slider_img.png" class="small_product_img">
                                </div>
                            </div>
                            <div>
                                <div class="bucket_na_zakaz">
                                    Букет индиго
                                </div>
                                <div class="price">
                                    5400 Р
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="history_order_item">
                        <div class="catalog_flex" style="align-items: normal;justify-content: normal">
                            <div class="small_product_card" style="margin-right:15px;">
                                <div class="small_product_place">
                                    <img src="../static/img/slider_img.png" class="small_product_img">
                                </div>
                            </div>
                            <div>
                                <div class="bucket_na_zakaz">
                                    Букет индиго
                                </div>
                                <div class="price">
                                    5400 Р
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% include 'pc_utilites.html' %}
<script>

    let maping = document.getElementsByClassName('catalog_category_item');

    // Доделать!!!!!!


    for (let i = 0; i < maping.length; i++) {
        maping[i].onclick = function () {
            changeBtnActive(maping[i]);
        }


        function changeBtnActive(btn) {
            if (btn.classList.contains('_active')) {
                return;
            }
            else {
                btn.classList.add('_active');
            }
        }
    }


    // personal_info_map.onclick = function () {
    //     personal_info_map.classList.add('_active');
    //     personal_info.style.display = 'block';
    //     personal_address.style.display = 'none';
    //     personal_history.style.display = 'none';
    //     let maping = document.getElementsByClassName('catalog_category_item');
    //     for (let i = 0; i < maping.length; i++) {
    //         if (maping[i].classList.contains('_active') && !personal_info_map.classList.contains('_active')) {
    //             maping[i].classList.remove('_active');
    //         }
    //     }
    // }
    // personal_address_map.onclick = function () {
    //     personal_address_map.classList.add('_active');
    //     personal_address.style.display = 'block';
    //     personal_info.style.display = 'none';
    //     personal_history.style.display = 'none';
    //     let maping = document.getElementsByClassName('catalog_category_item');
    //     for (let i = 0; i < maping.length; i++) {
    //         if (maping[i].classList.contains('_active') && !personal_address_map.classList.contains('_active')) {
    //             maping[i].classList.remove('_active');
    //         }
    //     }
    // }
    // personal_history_map.onclick = function () {
    //     personal_history_map.classList.add('_active');
    //     personal_history.style.display = 'block';
    //     personal_info.style.display = 'none';
    //     personal_address.style.display = 'none';
    //     let maping = document.getElementsByClassName('catalog_category_item');
    //     for (let i = 0; i < maping.length; i++) {
    //         if (maping[i].classList.contains('_active') && !personal_history_map.classList.contains('_active')) {
    //             maping[i].classList.remove('_active');
    //         }
    //     }
    // }
    send_old_pas.onclick = function () {
        checkingOldPassword();
    }
    save_changes.onclick = function () {
        EditUser(1);
    }

    birthday_day.oninput = function () {
        if (birthday_day.value.length > 2) {

        }
    }
    birthday_month.oninput = function () {

    }
    birthday_year.oninput = function () {

    }


    /* Получение пользователя */
    GetUser();

    function GetUser() {
        $.ajax({
            url: '/api/user/get',
            type: 'GET',
            success: function (msg) {
                user = msg['user'];
                DrawInfoUser();
            }
        });
    }

    function DrawInfoUser() {
        console.log(user);
        name_user.innerText = user['name'];
        your_name.value = user['name'];
        your_surname.value = user['surname'];
        your_mobile.value = '+7' + user['phone'];
        your_email_address.value = user['email'];
    }


    /* Проверка старого пароля на правильность */
    function checkingOldPassword() {
        if (old_password.value === '') {
            alert('Вы ничего не ввели');
            return;
        } else {
            let data = {
                'user_id': user['id'],
                'password': old_password.value,
            }
            $.ajax({
                url: '/api/user/check_password',
                data: data,
                type: 'GET',
                success: function (msg) {
                    console.log(msg);
                    place_for_old_pas.style.display = 'none';
                    enter_new_pas.style.display = 'block';
                    save_new_pas.onclick = function () {
                        EditUser(2);
                    }
                }
            })
        }
    }


    /* Загрузка аватара */
    avatar.onchange = e => {
        let file = e.target.files[0];
        comment_getBase64(file);
    }


    function comment_getBase64(file) {
        let filename = file.name;
        console.log(filename);
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
            let data = {
                'file': reader.result,
                'filename': filename
            }
            $.ajax({
                url: '/site/loadPhoto',
                type: 'POST',
                data: data,
                success: function (msg) {
                    let uuid = msg['uuid'];
                }
            });
        };
        reader.onerror = function (error) {
        };
    }


    function EditUser(status) {
        // status = 1 - изменение основных данных, 2 - пароля
        if (status === 1) {
            if (your_name.value === '') {
                alert('Вы не ввели имя');
                return;
            } else if (your_mobile.value === '') {
                alert('Вы не ввели мобильный телефон');
                return;
            } else if (your_name.value === user['name'] && your_mobile.value === '+7' + user['phone'] && your_surname.value === user['surname']) {
                notification('Информация не поменялась', 1);
                return;
            } else {
                let birthday = birthday_year + '.' + birthday_month + '.' + birthday_day;
                let data = {
                    'id': user['id'],
                    'name': your_name.value,
                    'surname': your_surname.value,
                    'phone': your_mobile.value,
                    'birthday': birthday,
                }
                $.ajax({
                    url: '/api/user/edit',
                    data: data,
                    type: "GET",
                    success: function (msg) {
                        console.log(msg);
                        alert('Ваши данные успешно изменены');
                    }
                })
            }
        } else {
            if (new_pass.value === '') {
                new_pass.classList.add('error');
                return;
            } else if (new_pass.value.length < 7) {
                new_pass.classList.add('error');
                notification('Пароль должен содержать более 6 символов', 1);
                return;
            } else if (new_pass.value !== new_pass_repeat.value) {
                notification('Пароли не совпадают', 1);
                return;
            } else {
                let data = {
                    'id': user['id'],
                    'password': new_pass.value,
                }
                $.ajax({
                    url: '/api/user/edit',
                    data: data,
                    type: "GET",
                    success: function (msg) {
                        notification('Ваш пароль успешно изменён', 2);
                    }
                })
            }
        }
    }

    function changeAddress() {
        let data = {
            'id': user['id'],
            'address': '',
        }
        $.ajax({
            url: 'api/user/add_address',
            data: data,
            type: "GET",
            success: function (msg) {
                console.log(msg);
            }
        })
    }


</script>
</body>
</html>